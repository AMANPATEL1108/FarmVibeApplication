<!DOCTYPE html>
<html lang="en" th:fragment="content" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Profile | Farm Vibe</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
</head>
<body class="bg-gray-100">
<div class="container mx-auto py-8">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Left Panel: User Info -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center space-x-4 mb-6">
                <img th:src="@{${user.profileImageUrl}}" alt="Profile Image"
                     class="w-24 h-24 rounded-full border-2 border-gray-300">
                <div>
                    <h2 class="text-xl font-semibold">Edit Profile</h2>
                </div>
            </div>
            <form id="profile-form" class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" th:value="${user.user_firstName + ' ' + user.user_lastName}" id="profileName"
                           class="mt-1 block w-full border border-gray-300 rounded-md p-2" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" th:value="${user.user_email}" id="profileEmail"
                           class="mt-1 block w-full border border-gray-300 rounded-md p-2" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Phone</label>
                    <input type="text" th:value="${user.mobileNumber}" id="profilePhone"
                           class="mt-1 block w-full border border-gray-300 rounded-md p-2" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Address</label>
                    <input type="text"
                           th:value="${user.addresses[0]?.house_number + ', ' + user.addresses[0]?.street + ', ' + user.addresses[0]?.pincode}"
                           id="profileAddress"
                           class="mt-1 block w-full border border-gray-300 rounded-md p-2" disabled>
                </div>
                <button type="button" onclick="openModal('details')"
                        class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                    Edit Details
                </button>
            </form>
        </div>

        <!-- Right Panel: Addresses -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4">Saved Addresses</h2>
            <div class="space-y-3">
                <div th:each="addr, iterStat : ${addresses}" th:id="${'address' + iterStat.index}"
                     class="flex items-start justify-between border p-3 rounded bg-gray-50">
                    <div class="text-sm">
                        <p class="text-gray-500 font-medium mb-1" th:text="'Address ' + (iterStat.index + 1)"></p>
                        <p>
                            <strong th:text="${addr.house_number}"></strong>,
                            <span th:text="${addr.street}"></span> - <span th:text="${addr.pincode}"></span>
                        </p>
                        <input type="hidden" th:value="${addr.house_number}" class="addr"/>
                        <input type="hidden" th:value="${addr.street}" class="city"/>
                        <input type="hidden" th:value="${addr.pincode}" class="pin"/>
                    </div>
                    <div class="space-x-2">
                        <button th:onclick="|openAddressModal(${iterStat.index})|"
                                class="text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Edit
                        </button>
                        <button th:onclick="|confirmDeleteAddress(${iterStat.index})|"
                                class="text-sm bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="modals"></div>
<script>
    let currentAction = '';
    let currentAddressId = null;

    function openModal(action) {
        currentAction = action;
        if (action === 'details') {
            document.getElementById('modals').innerHTML = getEditDetailsModal();
            document.getElementById('modalName').value = document.getElementById('profileName').value;
            document.getElementById('modalEmail').value = document.getElementById('profileEmail').value;
            document.getElementById('modalPhone').value = document.getElementById('profilePhone').value;
            document.getElementById('modalAddress').value = document.getElementById('profileAddress').value;
            document.getElementById('editModal').classList.remove('hidden');
        }
    }

    function closeModal(id) {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
    }

    function updateDetails() {
        closeModal('editModal');
        showVerificationModal();
    }

    function showVerificationModal() {
        document.getElementById('modals').innerHTML += `
          <div id="verifyOptionModal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg w-full max-w-sm animate__animated animate__fadeInDown relative">
              <button onclick="closeModal('verifyOptionModal')" class="absolute top-2 right-3 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
              <h3 class="text-lg font-semibold mb-4">Phone Verification</h3>
              <div class="space-y-3">
                <button onclick="selectVerification('phone')" class="w-full bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600">Verify via Phone</button>
              </div>
            </div>
          </div>`;
    }

    function selectVerification(method) {
        const phone = document.getElementById('profilePhone').value;
        fetch('/send-otp?phone=' + encodeURIComponent(phone), { method: 'POST' })
            .then(() => {
                document.getElementById('verifyOptionModal').classList.add('hidden');
                document.getElementById('modals').innerHTML += getOTPModal();
                document.getElementById('otpModal').classList.remove('hidden');
            })
            .catch(() => alert("Failed to send OTP."));
    }

    function getOTPModal() {
        return `
          <div id="otpModal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg w-full max-w-sm animate__animated animate__fadeInUp relative">
              <button onclick="closeModal('otpModal')" class="absolute top-2 right-3 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
              <h3 class="text-lg font-semibold mb-4">Enter 6-digit OTP</h3>
              <input type="text" maxlength="6" id="otpInput"
                     class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-center text-xl tracking-widest"
                     placeholder="______">
              <button onclick="verifyOTP()" class="mt-4 w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Verify</button>
            </div>
          </div>`;
    }

    function verifyOTP() {
        const otp = document.getElementById('otpInput').value;
        const phone = document.getElementById('profilePhone').value;

        if (otp.length === 6 && /^\d{6}$/.test(otp)) {
            fetch('/verify-otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `phone=${encodeURIComponent(phone)}&otp=${encodeURIComponent(otp)}`
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('otpModal').classList.add('hidden');

                    const name = document.getElementById('modalName').value.trim();
                    const email = document.getElementById('modalEmail').value.trim();
                    const newPhone = document.getElementById('modalPhone').value.trim();
                    const address = document.getElementById('modalAddress').value.trim();
                    const userId = localStorage.getItem('userId');

                    fetch('/user/update-profile', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId, name, email, phone: newPhone, address })
                    })
                    .then(res => {
                        if (res.ok) {
                            window.location.reload();
                        } else {
                            alert("Update failed.");
                        }
                    });
                } else {
                    alert("Invalid OTP.");
                }
            });
        } else {
            alert("Please enter a valid 6-digit OTP.");
        }
    }

    function getEditDetailsModal() {
        return `
          <div id="editModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
            <div class="bg-white p-6 rounded-lg w-full max-w-md relative animate__animated animate__fadeIn">
              <button onclick="closeModal('editModal')" class="absolute top-2 right-3 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
              <h3 class="text-lg font-semibold mb-4">Edit Your Details</h3>
              <form class="space-y-3">
                <input type="text" id="modalName" class="w-full p-2 border rounded" placeholder="Name">
                <input type="email" id="modalEmail" class="w-full p-2 border rounded" placeholder="Email">
                <input type="text" id="modalPhone" class="w-full p-2 border rounded" placeholder="Phone">
                <input type="text" id="modalAddress" class="w-full p-2 border rounded" placeholder="Address">
                <button type="button" onclick="updateDetails()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Update Details</button>
              </form>
            </div>
          </div>`;
    }
</script>

</body>
</html>
